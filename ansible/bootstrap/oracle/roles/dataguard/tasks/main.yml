---
- block:

  - name: copy archive log mode sql 
    template: src=archieve.sql.j2 dest=/tmp/archieve.sql
    when: inventory_hostname in groups['ora-x1']

  - name: Create_standbyDB | execute postsql from the standby database
    become_user: "{{ oracle_user }}"
    shell: echo "@{{ stage_dir }}/archieve.sql;" | sqlplus / as sysdba
    when: inventory_hostname in groups['ora-x1']

  - name: copy TNS LISTENER FILE to servers
    become_user: "{{ oracle_user }}"
    template: src=tnsnames.ora.j2 dest=/u01/app/oracle/product/19.3.0/dbhome_1/network/admin/tnsnames.ora

  - name: copy LISTENER FILE to primary
    when: inventory_hostname in groups['ora-x1']
    become_user: "{{ oracle_user }}"
    template: src=listener_primary.ora.j2 dest=/u01/app/oracle/product/19.3.0/dbhome_1/network/admin/listener.ora

  - name: copy LISTENER FILE to standby
    when: inventory_hostname in groups['ora-x2']
    become_user: "{{ oracle_user }}"
    template: src=listener_standby.ora.j2 dest=/u01/app/oracle/product/19.3.0/dbhome_1/network/admin/listener.ora

  - name: Create Folder Strucutre in Standby
    when: inventory_hostname in groups['ora-x2']
    become_user: "{{ oracle_user }}"
    file:
      path: "{{ item }}"
      state: directory
      owner: oracle
      group: oinstall
    loop:
      - /u01/app/oracle/oradata/ORCLDG1
      - /u01/app/oracle/fast_recovery_area/ORCLDG1
      - /u01/app/oracle/admin/ORCLDG1/adump

  - name: Copy Oracle Password File from Primary to Standby
    run_once: true
    fetch: src=/u01/app/oracle/product/19.3.0/dbhome_1/dbs/orapworcl dest=temp/ flat=yes
    when: inventory_hostname in groups['ora-x1']
  - name: Copy the file from the ansible to nodes
    copy: src=temp/orapworcl dest=/u01/app/oracle/product/19.3.0/dbhome_1/dbs/orapwORCLDG1
    when: inventory_hostname in groups['ora-x2']

  - name: Copy init.ora file
    become_user: "{{ oracle_user }}"
    shell: src=init.ora dest=/u01/app/oracle/product/19.3.0/dbhome_1/dbs/init.ora
    when: inventory_hostname in groups['ora-x2']


  - name: copy standby startup sql 
    template: "src=standby_start.sql.j2 dest={{ stage_dir }}/standby_start.sql"
    when: inventory_hostname in groups['ora-x2']
 
  - name: Start Oracle Instance on Standby
    when: inventory_hostname in groups['ora-x2']
    shell: echo "@{{ stage_dir }}/standby_start.sql;" | sqlplus / as sysdba

  - name: Stop  TNS Listener
    when: inventory_hostname in groups['ora-x2']
    shell: lsnrctl stop

  - name: Start  TNS Listener
    when: inventory_hostname in groups['ora-x2']
    shell: lsnrctl start

  - name: Copy RMAN Script
    when: inventory_hostname in groups['ora-x1']
    template: src=rman.sql.j2 dest=/tmp/rman.sql

  - name: Start RMAN Process
    when: inventory_hostname in groups['ora-x1']
    shell: echo "@{{ stage_dir }}/rman.sql;" | rman TARGET sys/Oracle123.?@orcl AUXILIARY sys/Oracle123.?@orcldg1


  become: true
  become_user: "{{ oracle_user }}"


  